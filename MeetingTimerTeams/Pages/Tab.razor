@page "/tab"
@using Microsoft.Extensions.Configuration
@using System.IO
@using Microsoft.Graph
@inject NavigationManager MyNavigationManager
@inject IConfiguration Configuration
@inject IJSRuntime jsRuntime

<div class="welcome page">
    <div class="narrow page-padding">
        <img src="hello.png" />
        <h1 class="center">
            Meeting Zen
        </h1>
        <h3>5min for your mind and between meetings</h3>


        @if (calendarEvents != null)
        {            
            <FluentRadioGroup @bind-value="eventID" >
                @foreach (var cal in calendarEvents)
                {
                    <FluentRadio Value="@cal.Subject" @onclick="(() => PrintValue(cal.Subject))" >@cal.Subject</FluentRadio>
                }

            </FluentRadioGroup>
        }

        Selected: @eventID

        @if (!String.IsNullOrEmpty(UserPhotoUri))
        {
            <div class="profile">
                <img class="avatar" src="@UserPhotoUri" />
                <div class="info">
                    <h3>@UserName</h3>
                    <p>@Title</p>
                    <p>@Email</p>
                </div>
            </div>
        }

        Meeting: 
        Start time: 
        End time:


        <div class="sections">
            @if (!IsLoading)
            {
                <h2>Get the user's profile photo!</h2>
                <InputComponent></InputComponent>

                <p>
                    Click below to authorize this app to read your profile photo using
                    Microsoft Graph.
                </p>
                <FluentButton Appearance="Appearance.Accent" @onclick="GetUserProfilePhoto">Authorize</FluentButton>
                <FluentButton Appearance="Appearance.Accent" @onclick="GetUserCalendar">Calendar</FluentButton>


            }
            else if (IsLoading)
            {
                <FluentProgressRing class="center" />
            }
        </div>

    </div>
</div>

@code {
    TeamsFx _teamsfx;
    TeamsFx teamsfx => _teamsfx ??= new TeamsFx(jsRuntime);
    string _clientId, _endpoint;

    public string UserName { get; set; }
    public string Email { get; set; }
    public string Title { get; set; }
    public string UserPhotoUri { get; set; }
    public bool IsLoading { get; set; }

    public string meetingTitle { get; set; }
    public string meetingStart { get; set; }
    public string meetingEnd { get; set; }

    

    public string eventID = "Test";
    public int dollars;

    public IUserCalendarViewCollectionPage calendarEvents { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            _clientId = Configuration.GetValue<string>("CLIENT_ID");
            _endpoint = MyNavigationManager.BaseUri;

            await teamsfx.Init(_clientId, _endpoint, _endpoint);

            var user = await teamsfx.GetInfoAsync();

            UserName = user.DisplayName;

            StateHasChanged();
        }
        catch (Exception) { }

    }

    public void PrintValue(string subject)
    {
        //Console.WriteLine("Got calendar details" + eventID);
        eventID = "Working! " + subject;
    }

    private async Task GetUserProfilePhoto()
    {
        try
        {
            IsLoading = true;

            var graphClient = teamsfx.GetGraphServiceClient();
            var photoStream = await graphClient.Me.Photo.Content.Request().GetAsync();
            var profile = await graphClient.Me.Request().GetAsync();

            if (photoStream != null)
            {
                // Copy the photo stream to a memory stream
                // to get the bytes out of it
                var memoryStream = new MemoryStream();
                photoStream.CopyTo(memoryStream);
                var photoBytes = memoryStream.ToArray();

                // Generate a data URI for the photo
                UserPhotoUri = $"data:image/png;base64,{Convert.ToBase64String(photoBytes)}";
            }

            Title = profile.JobTitle;
            Email = profile.Mail;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task GetUserCalendar()
    {

        var queryOptions = new List<QueryOption>()
    {
    new QueryOption("startdatetime", "2021-06-28T00:58:03.688Z"),
    new QueryOption("enddatetime", "2021-07-05T00:58:03.688Z")
    };


        var graphClient = teamsfx.GetGraphServiceClient();
        try
        {
            var calendar = await graphClient.Me.CalendarView.Request(queryOptions).GetAsync();

            calendarEvents = calendar;
            //string calType = calendar.GetType().ToString();
            //Console.WriteLine("Got calendar details" + calType);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error " + ex.Message);
        }
    }

}
